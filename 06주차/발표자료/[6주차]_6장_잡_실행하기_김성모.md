# 6장 잡 실행하기

> 목표 : 어떻게 스프링부트를 사용해 스프링 배치 잡을 쉽게 실행하는 지 알아본다. 


## 스프링 부트로 배치 잡 시작시키기

스프링 부트는 `CommandLineRunner` 와 `ApplicationRunner` 라는 두 가지 메커니즘을 이용해 실행 시 로직을 수행한다.

이 두 인터페이스는 `ApplicationContext` 가 리프레시가 되고 애플리케이션이 코드를 실행할 준비가 된 이후에 호출되는 하나의 메서드를 갖고 있다.

스프링 부트를 스프랭 배치와 함께 사용할 때는 `JobLauncherCommandLineRunner` 라는 특별한 `CommandLineRunner` 가 사용된다.

`JobLauncherCommandLineRunner` 는 스프링 배치의 JobLauncher를 사용해 잡을 실행한다.

1. `Spring-boot-starter-batch` 가 클래스패스에 존재할 때
2. `JobLauncherCommandLineRunner` 는 `ApplicationContext` 내 등록된 모든 `Job` 을 실행한다.

하지만 경우에 따라서 REST 호출이나 특정 이벤트로 배치 잡을 실행할 경우에는 앱이 기동되는 시점에 잡이 실행되지 않길 원한다. 
이를 위해서 스프링 부트는 다음의 옵션을 통해 앱 기동 시 어떤 잡도 실행하지 않을 수 있다.

```properties
spring.batch.job.enabled=false
```

또한 경우에 따라서 컨텍스트에 여러 잡이 정의돼 있는 경우에 특정한 잡만 실행하고 싶을 때는 다음의 프로퍼티를 사용해 
앱 기동 시 실행할 잡을 구성할 수 있다. 

실행할 잡이 여러 개인 경우 쉼표로 구분한다.

```properties
spring.batch.job.names=methodInvokingJob,systemCommandJob
```

이 외에도 개발자가 자신만의 메커니즘으로 잡을 실행할 수 있으며 이에 대해서 더 알아보자.


## REST 방식으로 잡 실행하기

프로그래밍해서 배치 잡을 실행하기 위해서 `JobLauncher` 가 필요하다.

```java
public interface JobLauncher {
	public JobExecution run(Job job, JobParameters jobParameters) throws JobExecutionAlreadyRunningException,
			JobRestartException, JobInstanceAlreadyCompleteException, JobParametersInvalidException;
}
``` 

이는 잡을 실행시키는 인터ㅔ이스이며 run 메서드 하나만 존재한다. 이 메서드로 실행할 잡과 잡 파라미터를 아규먼트로 전달받는다. 

스프링 배치는 기본적으로 `SimpleJobLauncher` 를 제공한다. 기본적으로 제공하는 `SimpleJobLauncher` 는 잡 파라미터를 조작하는 것을 지원하지 않기 때문에 `JobParametersIncrementer` 를 사용하기 위해서는 미리 전달되기 전에 적용해야 한다.

REST 방식으로 잡을 실행하기 위한 구성 및 기본 셋팅은 다음의 링크를 참조하길 바란다.
 
참고 링크 : 

`ApplicationContext` 를 이용해 실행할 Job의 빈을 가져오고 
Request에서 받은 파라미터로 `JobParameters` 를 구성하여 `JobLauncher` 에 넣어 `run()` 메소드를 동작시켰다.


기본적으로 `JobLauncher` 는 동기식으로 실행 후 `ExitStatus` 를 반환한다.
하지만 배치 잡으로 많은 양이 처리되는 상황이라면 비동기 방식으로 실행하는 것이 적합하며 이때에는 `JobExecutionId` 만 반환한다.


REST 방식으로 배치 잡을 사용할 때, 잡의 재시작이나 잡 파라미터 증가 처리등의 방법이 필요하다. 

1. 잡 파라미터 증가시키는 방법

`JobParametersBuilder`의 `getNextJobParameters` 메서드로 편리하게 작업할 수있다. 


```java
/* 파라미터 조작 */
@PostMapping("/run-2")
public ExitStatus runJob2(@RequestBody JobLauncherRequest jobLauncherRequest) throws JobParametersInvalidException, JobExecutionAlreadyRunningException, JobRestartException, JobInstanceAlreadyCompleteException {
    Job job = this.applicationContext.getBean(jobLauncherRequest.getName(), Job.class);
    JobParameters jobParameters = new JobParametersBuilder(jobLauncherRequest.getJobParameters(), this.jobExplorer)
                                    .getNextJobParameters(job)
                                    .toJobParameters();

    return this.jobLauncher.run(job, jobParameters).getExitStatus();
}
```
 
 `.getNextJobParameters(job)` 메서드를 실행하면 run.id 라는 파라미터가 추가된 새로운 JobParameters 인스턴스가 생성된다. 
 만약 실행시키는 `Job`이 `JobParametersIncrementer`를 가지고 있다면 `JobExecution`에 사용됐던 `JobParameters`를 적절하게 처리한다.
 
 
 
 ## 쿼츠를 사용해 스케줄링하기
 
 쿼츠 잡을 작성하여 잡을 실행할 수 있다. 이를 통해서 주기적으로 실행하는 스케줄링이 가능하다.
 
 참고 코드 : 
 
 `QuartzJobBean` 클래스를 상속한 클래스를 구현한다. `executeInternal` 메서드를 재정의해 목적에 맞게 확장한다.
 
 