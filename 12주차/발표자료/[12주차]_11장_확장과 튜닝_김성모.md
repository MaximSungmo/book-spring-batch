# 11장. 확장과 튜닝



## 배치 잡 프로파일링



>  프로파일링을 통해서 최적화와 관련된 의사결정을 내릴 수 있고 어플리케이션의 성능을 높일 수 있다.



### VisualVM 알아보기

> JVM이 어떤 상태인지 파악할 수 있는 도구이다.
>
> CPU 및 메모리 사용량, 메서드 실행 시간, 스레드 관리, GC 관련 정보 제공한다.



#### 설치

VisualVM 을 알아보기 위해서는 다음의 순서로 사전 작업을 진행한다.

- VisualVM 설치하기(https://visualvm.github.io/index.html)
- IntelliJ와 연동하기 (플러그인 : visualvm launcher)
- 실행해보기



#### 화면설명

- Overview : 실행 중인 자바 어플리케이션의 개요 제공. 
  main 클래스, 어플리케이션 이름, 프로세스ID, Arguments 등 
- Monitor : CPU사용률, 메모리 사용률, 로딩된 클래스 개수, 데몬 스레드의 수
  GC를 실행시킬 수 있으며 Heap dump 도 생성할 수 있다.
- Threads : 어플이 실행한 모든 스레드와 작업 정보 표시한다. 
- Sampler : CPU 사용률과 메모리 할당 상태를 스냅샷으로 만들어낸다. 



Monitor 탭에서 JVM의 관점으로 CPU 또는 메모리의 상태를 파악하며 이때 파악된 문제점의 원인을 찾을 때 다른 여러탭을 활용한다.



#### 스프링 배치 어플리케이션 프로파일링하기

> 어플리케이션 프로파일링 시 두 가지 중 하나를 살펴본다.
>
> 1. 어떤 부분에서 많은 CPU를 사용하는가?
> 2. 무엇 때문에 많은 메모리가 사용되는가? 



##### CPU 프로파일링

CPU 사용률과 관련된 데이터를 얻는 방법을 알아보자.





## 배치 잡의 여러 확장성



### 다중 스레드 스텝

- 청크단위를 쓰레드로 일을 나눠서 처리할 수 있다.
  장점 : 청크를 병렬로 생성하므로 빠른 작업이 가능하다. 
  단점 : ItemReader의 상태를 유지하는 stateful 기능이 여러 스레드에서 덮어쓰기하여 리더 상태가 제대로 저장되지 않는다.
  또한 이미 네트워크, 디스크버스등 자원 모두 소모하고 있을 땐 성능이 나아지지 않는다.

### 병렬 스텝

스텝을 병렬로 실행하여 영향을 주지 않는 스텝들을 분리하여 전반전익 잡의 처리량을 늘리는 방법에 대해 살펴보자.



### 파티셔닝

> 마스터 스텝이 처리할 일을 여러 워커 스텝으로 넘기는 개념이다.
>
> 파티션 스텝에서 큰 데이터셋은 더 작은 파티션으로 나뉘어 각 파티션이 병렬로 처리한다. 
>
> 각 워커는 읽기, 처리, 쓰기를 담당하는 온전한 스프링 배치 스텝이다. 



크게 두가지의 추상화 를 이해해야한다.

1. `partitioner` 인터페이스 를 사용하여 여러 파티션으로 나누는 역할을 한다.
   기본적으로 `MultiResourcePartitioner`를 제공하는데. 리소스당 파티션을 만든다.
2. `partitionHandler` 워커와 의사 소통을 하는 데 사용되는 인터페이스이다. 



### 원격 청킹













