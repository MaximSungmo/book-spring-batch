# 4장. 잡과 스텝 이해하기

[toc]

## 잡 소개하기

잡(Job) : 처음부터 끝까지 독립적으로 실행할 수 있는 고유하며 순서가 지정된 여러 스텝의 목록

- 유일하게 구성하여 빈으로 등록하고 필요한 만큼 사용할 수 있다.
- 순서를 가진 여러 스텝의 목록이다.
- 처음부터 끝까지 실행 가능하며 외부 의존성 없이 실행할 수 있는 일련의 스텝이다.

- 각 배치의 잡은 외부 의존성의 영향을 받지 않고 독립적으로 실행할 수 있어야한다. 

### 잡의 생명주기

잡의 실행 

- CommandLineJobRunner
- JobRegistryBackgroundJobRunner
- (스프링부트) JobLauncherCommandLineRunner



TaskExcutor를 구성하는 여러가지 방법

- SyncTaskExecutor : JobLauncher와 동일한 스레드에서 실행 



잡 실행 -> `JobInstance` 생성 (식별방법 : 잡 이름, 식별 파라미터)

`JobInstance`에 대한 상태 관리는 JobRepository가 사용하는 BATCH_JOB_INSTANCE, BATCH_JOB_EXECUTION_PARAMS 테이블을 사용함(BATCH_JOB_INSTANCE.JOB_KEY 는 잡이름과 식별 파라미터의 해시값이다.)



`JobExecution`은 잡 실행의 실제 시도를 의미

JobExecution은 BATCH_JOB_EXECUTION 테이블의 레코드로 저장되며 실행될 때의 상태는 BATCH_JOB_EXECUTION_CONTEXT 테이블에 저장. 



#### 잡(Job), JobInstance, JobExcetuion 간의 관계

`Job` - 여러개의 `JobInstance` -> 여러개의 `JobExecution`



## 잡 구성하기

### 잡의 기본 구성 

```
생성 코드
```

코드 설명 추가



### 잡 파라미터

#### 잡 파라미터 전달

> 기억하기 : JobInstance 식별  방법(잡 이름, 식별 파라미터)

잡에 파라미터 전달하는 방법 : JobParameters 객체를 생성해 obInstance에 전달하는 것 

- JobLauncherCommandLineRunner에서 파라미터 전달하기.  `key=value`

```
java -jar demo.jar name=Michael
```

> 주의 ! JobParameter는 " -- " prefix를 사용해 전달하면 안 된다.
>
> 또한 시스템 프로퍼티도 아니므로 " -D argument"를 사용해 전달해서도 안 된다.

- 파라미터 타입을 지정하고 싶은 경우 `key(type소문자) = value` (허용 가능한 type : string, double, date, long 등)

```
java -jar demo.jar executionDate(date)=2020/12/27
```

- 특정 잡 파라미터가 식별에 사용되지 않도록 지정하기 (방식 : " - " prefix)

```
java -jar demo.jar executionDate(date)=2020/12/27 -name=Michael
```

잡에 전달한 파라미터 확인을 위해서 BATCH_JOB_EXECUTION_PARAMS 테이블을 살펴보면 된다.



#### 잡 파라미터 접근하기

파라미터에 접근하는 위치에 따른 방식

- ChunkContext : (StepContribution, ChunkContext) => {}
- Late binding : 



#### 잡 파라미터 유효성 검증하기

잡 파라미터를 받아들일 때 검증하도록 인터페이스 구현체를 만들 수 있다.

```java
public class ParameterValidator implements JobParameterValidator {
	@Override
	public void validate(JobParameters parameters) {
		...
		Throw new JobParametersInvalidException("");
	}
}
```

에러가 발생하여 `JobParametersInvalidException` 이 발생하지 않는 한 유효성 통과로 판단한다.



커스텀 유효성 검증을할 수 있지만 필수 파라미터 누락 검증기도 제공한다.

```java
@Bean
public JobParametersValidator validator() {
	DefaultJobParametersValidator validator = new ..
	validator.setRequiredKeys(new String[]{"키값"});
	validator.setOptionalKeys(new String[]{"키값"});
}
```

```java
@Bean
public Job job() {
	return this.jobBuilderFactory.get("basicJob")
                .start(step1())
                .validator(validator())
                .build();
}
```

이제 배치 잡 시작 시 유효성 검증기를 잡에 추가해보자. 

기본적으로는 잡에 유효성 검증기가 1개만 추가 가능하나, 위의 2개 모두 추가하고 싶은 경우에는 `CompositeJobParametersValidator` 를 활용한다.



#### 잡 파라미터 증가시키기

JobInstance 는 잡이름과 식별 파라미터에 의해서 식별되며 이는 한 번밖에 사용하지 못한다고 했다.

그렇다면 어떻게 계속해서 실행시키며 중복을 피할 수 있을까?

방법은 `JobParametersIncrementer` 를 사용하는 것이다. 그 중 대표적으로 `RunIdIncrementer` 를 사용할 수 있다. 

```java
@Bean
public Job job() {
	return this.jobBuilderFactory.get("basicJob")
                .start(step1())
                .validator(validator())
                .incrementer(new RundIdIncrementer())               
                .build();
}
```

하루에 한 번 실행될 때 타임 스탬프를 파라미터로 사용할 수 있다. 또는 별도의 조건으로 잡을 실행시킬 때 파라미터가 자동증가되어 중복실행방지를 회피하고 싶은 경우에는 `JobParameterIncrementor` 를 구현하여 직접 커스텀할 수 있다.  



#### 잡 리스너 적용하기

잡 실행과 관련하여 `JobExecutionListener` 가 있다. 이 인터페이스는 `beforeJob` 과 `afterJob` 의 두 메서드를 제공한다.

잡 리스너를 적용하여 다음의 사례에서 활용할 수 있다.

- 알림 (잡 시작 전 후 알람메세지 전송)
- 초기화 (잡 실행 전 로직 초기화)
- 정리 (잡 실행 후 파일 또는 자원 정리)

잡에 리스너를 추가하는 방법은 `JobExecutionListener` 를 구현하여 추가해주면 된다.

```java
@Bean
public Job job() {
	return this.jobBuilderFactory.get("basicJob")
                .start(step1())
                .validator(validator())
                .incrementer(new DailyJobTimestamper())
                .listener(new JobLoggerListener()) // 구현체 추가 
                .build();
}
```



#### ExecutionContext

: 배치 잡의 세션